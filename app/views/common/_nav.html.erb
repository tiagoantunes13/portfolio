<!-- Modern Dashboard Header -->
<header class="bg-white border-b border-gray-200 shadow-lg sticky top-0 z-50">
  <div class="max-w-7xl mx-auto">
    <div class="flex items-center justify-between px-4 sm:px-6 lg:px-8 py-4">
      <!-- Logo / Brand -->
      <%= link_to send(UiConfig::MAIN_NAV.first[:path]), class: "flex items-center gap-3 group" do %>
        <%= image_tag UiConfig::BRAND[:logo_path], class: "w-10 h-10 transform group-hover:scale-110 transition-transform duration-200", alt: UiConfig::BRAND[:logo_alt] %>
        <h2 class="text-indigo-600 text-xl font-bold leading-tight tracking-tight group-hover:text-indigo-700 transition-colors"><%= UiConfig::BRAND[:name] %></h2>
      <% end %>

      <!-- Primary Navigation (Desktop) -->
      <nav class="hidden lg:flex items-center space-x-1">
        <% UiConfig::MAIN_NAV.each do |item| %>
          <%= link_to send(item[:path]), class: "flex items-center gap-2 px-4 py-2 rounded-xl text-gray-700 hover:text-indigo-600 hover:bg-indigo-50 font-medium transition-all duration-200 #{current_page?(send(item[:path])) ? 'bg-indigo-50 text-indigo-600' : ''}" do %>
            <%= render_nav_icon(item) %>
            <span><%= item[:name] %></span>
            <%= render_badge(item[:badge], current_user) if item[:badge] %>
          <% end %>
        <% end %>

        <!-- Tools Dropdown -->
        <div class="relative group">
          <input type="checkbox" id="tools-dropdown" class="hidden">
          <label for="tools-dropdown" class="flex items-center gap-2 px-4 py-2 rounded-xl text-gray-700 hover:text-indigo-600 hover:bg-indigo-50 font-medium transition-all duration-200 cursor-pointer">
            <%= render_icon(UiConfig::TOOLS_DROPDOWN[:icon]) %>
            <span><%= UiConfig::TOOLS_DROPDOWN[:label] %></span>
            <%= render_icon("chevron-down", css_class: "dropdown-arrow w-4 h-4 transition-transform duration-200") %>
          </label>
          <div class="dropdown-menu hidden absolute right-0 mt-2 w-64 min-w-max bg-white rounded-2xl shadow-xl border border-gray-200 py-2 z-50">
            <% UiConfig::TOOLS_NAV.each do |item| %>
              <%= link_to send(item[:path]), class: "flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors" do %>
                <%= render_nav_icon(item) %>
                <div>
                  <div class="font-medium"><%= item[:name] %></div>
                  <% if item[:description] %>
                    <div class="text-xs text-gray-500"><%= item[:description] %></div>
                  <% end %>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      </nav>

      <!-- User Menu (Desktop) -->
      <div class="hidden lg:flex items-center gap-3">
        <% if current_user.present? %>
          <div class="relative group">
            <input type="checkbox" id="user-dropdown" class="hidden">
            <label for="user-dropdown" class="flex items-center gap-3 px-4 py-2 rounded-xl hover:bg-gray-50 transition-all duration-200 border border-gray-200 cursor-pointer">
              <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-semibold text-sm">
                <%= current_user.email[0].upcase %>
              </div>
              <span class="font-medium text-gray-700"><%= current_user.email.split('@').first.capitalize %></span>
              <%= render_icon("chevron-down", css_class: "dropdown-arrow w-4 h-4 text-gray-500 transition-transform duration-200") %>
            </label>
            <div class="dropdown-menu hidden absolute right-0 mt-2 w-64 min-w-max bg-white rounded-2xl shadow-xl border border-gray-200 py-2 z-50">
              <% UiConfig::USER_MENU.each do |item| %>
                <% if item[:type] == :divider %>
                  <div class="border-t border-gray-200 my-2"></div>
                <% else %>
                  <% link_options = { class: "flex items-center gap-3 px-4 py-3 transition-colors" } %>
                  <% if item[:variant] == "danger" %>
                    <% link_options[:class] += " text-red-600 hover:bg-red-50 rounded-b-2xl" %>
                  <% else %>
                    <% link_options[:class] += " text-gray-700 hover:bg-indigo-50 hover:text-indigo-600" %>
                  <% end %>
                  <% link_options[:data] = { turbo_method: item[:method] } if item[:method] %>

                  <%= link_to send(item[:path]), **link_options do %>
                    <%= render_nav_icon(item) %>
                    <span class="font-medium"><%= item[:name] %></span>
                  <% end %>
                <% end %>
              <% end %>
            </div>
          </div>
        <% else %>
          <%= link_to 'Sign In', new_user_session_path, class: "btn-ghost" %>
          <%= link_to 'Get Started', new_user_registration_path, class: "btn-sm" %>
        <% end %>
      </div>

      <!-- Mobile Menu Button -->
      <button id="menu-toggle" class="lg:hidden text-gray-700 hover:text-indigo-600 focus:outline-none p-2 rounded-lg hover:bg-gray-100 transition-colors">
        <%= render_icon("menu", css_class: "w-6 h-6") %>
      </button>
    </div>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden lg:hidden border-t border-gray-200 bg-white">
      <div class="px-4 py-4 space-y-1">
        <% UiConfig::MAIN_NAV.each do |item| %>
          <%= link_to send(item[:path]), class: "flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition-all font-medium" do %>
            <%= render_nav_icon(item) %>
            <div class="flex items-center gap-2">
              <span><%= item[:name] %></span>
              <%= render_badge(item[:badge], current_user) if item[:badge] %>
            </div>
          <% end %>
        <% end %>

        <div class="border-t border-gray-200 my-2 pt-2">
          <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider"><%= UiConfig::TOOLS_DROPDOWN[:label] %></p>

          <% UiConfig::TOOLS_NAV.each do |item| %>
            <%= link_to send(item[:path]), class: "flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition-all font-medium" do %>
              <%= render_nav_icon(item) %>
              <span><%= item[:name] %></span>
            <% end %>
          <% end %>
        </div>

        <% if current_user.present? %>
          <div class="border-t border-gray-200 my-2 pt-2">
            <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Account</p>

            <% UiConfig::USER_MENU.each do |item| %>
              <% next if item[:type] == :divider %>
              <% link_options = { class: "flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium" } %>
              <% if item[:variant] == "danger" %>
                <% link_options[:class] += " text-red-600 hover:bg-red-50 mt-2" %>
              <% else %>
                <% link_options[:class] += " text-gray-700 hover:bg-indigo-50 hover:text-indigo-600" %>
              <% end %>
              <% link_options[:data] = { turbo_method: item[:method] } if item[:method] %>

              <%= link_to send(item[:path]), **link_options do %>
                <%= render_nav_icon(item) %>
                <span><%= item[:name] %></span>
              <% end %>
            <% end %>
          </div>
        <% else %>
          <div class="border-t border-gray-200 my-2 pt-2 px-4 flex flex-col gap-2">
            <%= link_to 'Sign In', new_user_session_path, class: "block text-center btn-ghost hover:bg-gray-50" %>
            <%= link_to 'Get Started', new_user_registration_path, class: "block text-center btn-sm" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <script>
    function setupHeaderInteractions() {
      // Mobile menu toggle
      const toggleBtn = document.getElementById('menu-toggle');
      const mobileMenu = document.getElementById('mobile-menu');

      if (toggleBtn && mobileMenu) {
        // Remove existing listener if any
        toggleBtn.replaceWith(toggleBtn.cloneNode(true));
        const newToggleBtn = document.getElementById('menu-toggle');

        newToggleBtn.addEventListener('click', () => {
          mobileMenu.classList.toggle('hidden');
        });
      }

      // Close dropdowns when clicking outside
      const toolsCheckbox = document.getElementById('tools-dropdown');
      const userCheckbox = document.getElementById('user-dropdown');

      document.addEventListener('click', (e) => {
        // Check if click is outside both dropdowns
        const clickedInsideTools = e.target.closest('#tools-dropdown') || e.target.closest('label[for="tools-dropdown"]') || e.target.closest('.dropdown-menu');
        const clickedInsideUser = e.target.closest('#user-dropdown') || e.target.closest('label[for="user-dropdown"]') || e.target.closest('.dropdown-menu');

        if (!clickedInsideTools && toolsCheckbox) {
          toolsCheckbox.checked = false;
        }
        if (!clickedInsideUser && userCheckbox) {
          userCheckbox.checked = false;
        }
      });
    }

    // Run on initial load
    document.addEventListener('turbo:load', setupHeaderInteractions);

    // Run after Turbo renders a page from cache or new content
    document.addEventListener('turbo:render', setupHeaderInteractions);

    // Clean up mobile menu state before caching
    document.addEventListener('turbo:before-cache', () => {
      const mobileMenu = document.getElementById('mobile-menu');
      if (mobileMenu) {
        mobileMenu.classList.add('hidden');
      }
    });
  </script>
</header>
